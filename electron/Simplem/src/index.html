<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- CSP設定（セキュリティ対策の一部）。scriptやeval()やcss,画像の読み込みなどでエラーが出る場合はここを調整要。 -->
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />

    <!-- main側で設定する場合は、コメントアウトが必要-->
    <!-- document.getElementsByTagName("title")[0].text = "*sample.text - Simplem" のような形でファイル名を反映させる？ -->
    <!--<title>Simplem</title>-->
    <!-- short hand, igniter, skillet, overwhelm, catalyst, gale, Simple Glint, SimpleGlint, Glint -->

    <!-- Bootstrap core CSS
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    -->
    <meta name="theme-color" content="#707070">

    <!-- font awesome CSS -->
    <link rel="stylesheet" href="css/all.min.css">

    <!-- preview CSS -->
    <link rel="stylesheet" href="css/preview.css">

    <!-- easymde CSS and JS -->
    <link rel="stylesheet" href="css/easymde.css">

    <!-- print CSS -->
    <link rel="stylesheet" href="css/print.css">

    <!-- font CSS -->
    <link id="font_css" rel="stylesheet" href="css/font/font_modern_os.css">


</head>

<script src="easymde.js"></script>

<body>
    <!--開く、保存、名前を付けて保存ボタン
    <div>
        <button id="open" type="button">Open</button>
        <button id="save" type="button">Save</button>
        <button id="save_as" type="button">Save as</button>
        <button id="some-button" type="button">Search</button>
    </div>
    -->

    <textarea id="my-text-area"></textarea>

</body>

<script>
    let easyMDE = new EasyMDE({
        element: document.getElementById('my-text-area'),
        autoDownloadFontAwesome: false,
        minHeight: "1px",
        //autosave: {
        //    enabled: true,
        //    delay: 1000,
        //    uniqueId: 'mde-autosave'
        //},
        previewImagesInEditor: false,
        //lineNumbers: true,
        autofocus: true,
        forceSync: true,
        hideIcons: ["fullscreen", "heading", "italic", "image"],
        //initialValue: "# Hello world!",
        //parsingConfig: { allowAtxHeaderWithoutSpace: true },
        renderingConfig: {
            singleLineBreaks: true,
            //codeSyntaxHighlighting: true,
        },
        //テーブル機能はオプションとして登録予定。'table',
        showIcons: ['strikethrough', 'code', 'redo', 'undo', 'heading-1', 'heading-2', 'heading-3', 'horizontal-rule'],
        spellChecker: false,
        status: ["lines"],
        //toolbar: false,
        toolbarTip: true,
        tabSize: 4,
        sideBySideFullscreen: false,


    });

    //イベントハンドラーの使用
    //easyMDE.codemirror.on("change", function () {
    //
    //    let ele_f_h1 = document.getElementsByClassName("cm-formatting-header-1");
    //    for (let i = 0; i < ele_f_h1.length; i++) {
    //
    //        if (ele_f_h1[i].innerHTML == "# ") {
    //            ele_f_h1[i].setAttribute("style", "display:none;");
    //
    //        } else {
    //            //ele_f_h1[i].setAttribute("style", "display:inline;");
    //        };
    //    }
    //});

</script>


<!-- 以下、electronのレンダラー用script -->
<script>




    //ipc経由の機能------------------------------------------------------------------<
    //nodeIntegrationをfalseにしたことで、以下は使えなくなった
    //const {ipcRenderer, app} = require('electron');
    //
    //preload.jsで定義したことで、代わりに以下が使用可能
    let ipcRenderer = window.ipcRenderer;
    const app = window.app;


    //mainからのファイル読み込み命令を処理
    ipcRenderer.on('open_from_main', async () => {
        const { canceled, data } = await ipcRenderer.invoke('open') //mainのopenを呼び出し（data取得）
        if (canceled) return
        let file_text_data = '';
        file_text_data = data[0] || '';
        easyMDE.value(file_text_data);
    });

    //mainからの上書き保存命令を処理
    ipcRenderer.on('save_from_main', async () => {
        const text_data = easyMDE.value();
        await ipcRenderer.invoke('save', text_data); //mainのsaveを呼び出し(text_data受渡)
    });

    //mainからの名前を付けて保存命令を処理
    ipcRenderer.on('save_as_from_main', async () => {
        const text_data = easyMDE.value();
        await ipcRenderer.invoke('save_as', text_data);
    });

    //mainからの引数で渡されたファイル読み込み命令を処理
    ipcRenderer.on('open_init_from_main', async () => {
        const { data } = await ipcRenderer.invoke('open_init'); //mainのopen_initを呼び出し（data取得）
        let file_text_data = '';
        file_text_data = data || '';
        easyMDE.value(file_text_data);

    });

    //mainからのselectall命令を処理
    ipcRenderer.on('selectall_from_main', async () => {
        easyMDE.codemirror.execCommand('selectAll');

    });

    //mainからのclipboardへのhtmlコピー命令を処理
    ipcRenderer.on('html_to_clipboard_from_main', async () => {


        //プレビューhtmlの取得
        //let preview_html_plaintext = easyMDE.options.parent.markdown(easyMDE.value()); //でも可（同義）
        let preview_html_plaintext = easyMDE.options.previewRender(easyMDE.value());

        let domparser = new DOMParser();
        let preview_html_document = domparser.parseFromString(preview_html_plaintext, "text/html"); //DOM操作可能なdocumentオブジェを取得
        let parsered_preview_html_plaintext = preview_html_document.getElementsByTagName("body")[0].innerHTML;
        await ipcRenderer.invoke('html_to_clipboard', parsered_preview_html_plaintext);
    });

    //mainからの印刷命令を処理
    ipcRenderer.on('print_from_main', async () => {

        if (easyMDE.isPreviewActive() == false) {
            await easyMDE.togglePreview();
        }

        ipcRenderer.invoke('print');
    });

    //mainからのPDF出力命令を処理
    ipcRenderer.on('print_to_pdf_from_main', async () => {

        if (easyMDE.isPreviewActive() == false) {
            await easyMDE.togglePreview();
        }

        ipcRenderer.invoke('print_to_pdf');
    });

    //mainからのfont変更命令の処理
    ipcRenderer.on('change_font_from_main', async (event, font_kind) => {

        // id属性からHTML要素を取得
        let font_css_link = document.getElementById("font_css");

        //fontリンクのhref書き換え
        if (font_kind == "modern_os") {
            font_css_link.href = "css/font/font_modern_os.css";
        } else if (font_kind == "simplem") {
            font_css_link.href = "css/font/font_simplem.css";
        } else if (font_kind == "myricam") {
            font_css_link.href = "css/font/font_myricam.css";
        } else if (font_kind == "retro_rpg") {
            font_css_link.href = "css/font/font_retro_rpg.css";
        } else if (font_kind == "beautiful_pixel") {
            font_css_link.href = "css/font/font_pixel.css";
        } else if (font_kind == "beautiful_mincho") {
            font_css_link.href = "css/font/font_beautiful_mincho.css";
        }

    });

    //mainからのソースコードモードへの切替え命令を処理
    //ipcRenderer.on('toggle_sorcemode_main', async () => {
    // 作成中   <link rel="stylesheet" href="css/easymde.css" />
    //
    //});

    //let remote = window.remote;
    //let searchInPage = window.searchInPage;
    //mainからの検索窓オープンの命令を処理
    //ipcRenderer.on('webdata', async (webcontents_for_search) => {
    //    let inPageSearch = searchInPage(webcontents_for_search);
    //    inPageSearch.openSearchWindow();
    //});



    //ファイルの読み込みをmainから呼び出し（ボタン用）
    //document.querySelector('#open').addEventListener('click', async () => {
    //    const { canceled, data } = await ipcRenderer.invoke('open')
    //    if (canceled) return
    //    let file_text_data = '';
    //    file_text_data = data[0] || '';
    //    easyMDE.value(file_text_data);
    //});

    //ファイルの上書き保存をmainから呼び出し（ボタン用）
    //document.querySelector('#save').addEventListener('click', async () => {
    //    const text_data = easyMDE.value();
    //    await ipcRenderer.invoke('save', text_data);
    //});


    //ファイルの名前を付けて保存をmainから呼び出し（ボタン用）
    //document.querySelector('#save_as').addEventListener('click', async () => {
    //    const text_data = easyMDE.value();
    //    await ipcRenderer.invoke('save_as', text_data);
    //});


    //ipc経由の機能------------------------------------------------------------------>


    //トークン表示のテスト中---------------------------------------------------------------------<
    //一つまえのカーソルがアクティブだった場所をグローバル保存（シャープ表示テスト用）
    let arr_cur_pos = [{ init: null }];
    let arr_mark_state = [{ init: null }];
    //active-line状態のフラグ
    let flg_active_line = false;

    easyMDE.codemirror.on('cursorActivity', function () {

        //アルゴリズム
        //1 getstate.bold=trueならその行にactiveクラス（#や**を表示）追加。
        //2 カーソル移動ごとに一つ前のカーソルの行のmarkをクリア。（一つ前の行が今の行と同じならばクリア無し）

        //現在のカーソル位置の位置情報とマーク情報を取得
        let cur_pos = easyMDE.codemirror.getCursor();
        //console.log(cur_pos);//開発用 カーソル位置検出

        let mark_state = easyMDE.getState();
        //console.log(mark_state);//開発用 カーソル位置のマーク検出



        //一つまえのカーソル位置の、位置情報とマーク情報を取得（現在のカーソル位置情報も保管。先入れ後出し）
        arr_cur_pos.unshift(cur_pos);
        let cur_pos_previous = arr_cur_pos.pop();

        arr_mark_state.unshift(mark_state);
        let mark_state_previous = arr_mark_state.pop();

        //マークのクリア（直前のカーソル位置がマークの場合に実行）
        if (mark_state_previous.heading || mark_state_previous.bold || mark_state_previous.strikethrough || mark_state_previous.code) {

            //ヘッダーとボールドと取消し線のマークのクリア（現在のカーソル位置がマーク無しの場合に実行）
            if ((((!mark_state.heading) && (!mark_state.bold) && (!mark_state.strikethrough) && (!mark_state.code)) || (cur_pos.line != cur_pos_previous.line)) && (flg_active_line == true)) {
                easyMDE.codemirror.findMarksAt({ line: cur_pos_previous.line, ch: cur_pos_previous.ch })[0].clear();
                flg_active_line = !flg_active_line;
            }

            //ヘッダーのマークのクリア
            //if (((!mark_state.heading) || (cur_pos.line != cur_pos_previous.line)) && (flg_active_line == true)) {
            //    easyMDE.codemirror.findMarksAt({ line: cur_pos_previous.line, ch: cur_pos_previous.ch })[0].clear();
            //    flg_active_line = !flg_active_line;
            //}
        }

        //カーソル位置がヘッダーとボールドと取消し線の時に、テキストマーク(active-lineクラス)追加。
        if ((mark_state.bold || mark_state.heading || mark_state.strikethrough || mark_state.code) && (flg_active_line == false)) {
            //easyMDE.codemirror.markText({ line: cur_pos.line, ch: 0 }, { line: cur_pos.line + 1, ch: 0 }, { className: "active-line", clearOnEnter: true });//フラグ無しでやるならこっち
            easyMDE.codemirror.markText({ line: cur_pos.line, ch: 0 }, { line: cur_pos.line + 1, ch: 0 }, { className: "active-line", inclusiveRight: true });
            flg_active_line = !flg_active_line;
        }

        //テキストマーク追加
        //easyMDE.codemirror.markText({ line: 0, ch: 0 }, { line: 1, ch: 0 }, { className: "hhhhasdf" });

        //テキストマーククリア
        //easyMDE.codemirror.findMarksAt({ line: easyMDE.codemirror.getCursor().line, ch: easyMDE.codemirror.getCursor().line })[0].clear();

    });
    //トークン表示のテスト中--------------------------------------------------------------------->




</script>

</html>